#!/bin/sh
#
# Pre-commit hook to run rustfmt on staged Rust files
#

# Get list of staged .rs files
STAGED_RS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.rs$')

if [ -z "$STAGED_RS_FILES" ]; then
    exit 0
fi

# Check if rustfmt is available
if ! command -v rustfmt &> /dev/null; then
    echo "rustfmt not found. Please install it with: rustup component add rustfmt"
    exit 1
fi

# Run rustfmt --check on staged files
echo "Running rustfmt on staged Rust files..."

UNFORMATTED_FILES=""
for FILE in $STAGED_RS_FILES; do
    if [ -f "$FILE" ]; then
        if ! rustfmt --check "$FILE" 2>/dev/null; then
            UNFORMATTED_FILES="$UNFORMATTED_FILES $FILE"
        fi
    fi
done

if [ -n "$UNFORMATTED_FILES" ]; then
    echo ""
    echo "ERROR: The following files are not properly formatted:"
    for FILE in $UNFORMATTED_FILES; do
        echo "  - $FILE"
    done
    echo ""
    echo "Please run 'cargo fmt' to fix formatting issues."
    exit 1
fi

echo "All staged Rust files are properly formatted."
exit 0
